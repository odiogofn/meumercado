<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Compras Profissional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase opcional (s√≥ ser√° usado se CONFIG.useSupabase = true) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background: #0f172a;
      color: #e5e7eb;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 10px;
    }

    header h1 {
      margin: 0;
      font-size: 1.7rem;
      color: #f9fafb;
    }

    header span {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .card {
      background: #020617;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
      margin-bottom: 14px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title span.icon {
      font-size: 1.1rem;
    }

    .row-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .row-flex label {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .row-flex select,
    .row-flex input[type="text"],
    .row-flex input[type="email"],
    .row-flex input[type="password"] {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .row-flex input:focus,
    .row-flex select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    .orcamento-box {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .orcamento-box label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .orcamento-box input[type="number"] {
      width: 160px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 2fr 1.4fr 1.4fr 1fr 1fr 1.2fr auto;
      gap: 10px;
      margin-top: 12px;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .field input::placeholder {
      color: #6b7280;
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #0f172a;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-outline {
      background: transparent;
      color: #9ca3af;
      border-radius: 999px;
      border: 1px solid #4b5563;
    }

    .btn-outline:hover {
      background: #111827;
      color: #e5e7eb;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .btn-danger {
      background: #ef4444;
      color: #f9fafb;
    }

    .btn-danger:hover {
      filter: brightness(1.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 6px;
      font-size: 0.85rem;
      border-bottom: 1px solid #111827;
    }

    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td {
      color: #e5e7eb;
    }

    .right { text-align: right; }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #1f2937;
    }

    .tag-default { background: #0f172a; }

    .table-wrapper {
      max-height: 280px;
      overflow: auto;
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #111827;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-card {
      background: #020617;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid #111827;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .summary-value {
      font-size: 1rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .summary-extra {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .budget-bar-container { margin-top: 8px; }

    .budget-bar-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .budget-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      transition: width 0.3s ease;
    }

    .budget-status {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .budget-ok { color: #22c55e; }
    .budget-alerta { color: #eab308; }
    .budget-estourado { color: #ef4444; }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
      gap: 12px;
      margin-top: 10px;
    }

    .chart-card {
      background: #020617;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #111827;
    }

    .chart-card h3 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .chart-helper {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .table-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 10px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      padding: 3px 10px;
      border-radius: 999px;
      background: #111827;
      font-size: 0.75rem;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }

    /* MODAL EDI√á√ÉO */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-dialog {
      background: #020617;
      padding: 20px;
      width: 340px;
      max-width: 95%;
      border-radius: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 0 20px rgba(0,0,0,0.45);
    }

    .modal-title {
      margin: 0 0 12px 0;
      color: #e5e7eb;
      font-size: 1rem;
      font-weight: 600;
    }

    .edit-label {
      color: #9ca3af;
      font-size: 0.8rem;
      display: block;
      margin-bottom: 2px;
    }

    .edit-input {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .edit-input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      gap: 10px;
    }

    /* AUTH CARD */
    #authContainer {
      max-width: 420px;
      margin: 0 auto 16px auto;
    }

    #authStatus {
      font-size: 0.8rem;
      color: #9ca3af;
      min-height: 16px;
    }

    @media (max-width: 900px) {
      .form-grid {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "produto produto"
          "categoria categoria"
          "carteira carteira"
          "qtde unidade"
          "preco preco"
          "btn btn";
      }
      .field-produto { grid-area: produto; }
      .field-categoria { grid-area: categoria; }
      .field-carteira { grid-area: carteira; }
      .field-qtde { grid-area: qtde; }
      .field-unidade { grid-area: unidade; }
      .field-preco { grid-area: preco; }
      .field-btn { grid-area: btn; }

      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 600px) {
      .summary-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <!-- AUTH / LOGIN -->
    <div id="authContainer" class="card">
      <div class="section-title">
        <span class="icon">üîê</span> Acesso ao sistema
      </div>
      <div class="row-flex" style="flex-direction:column;align-items:stretch;gap:8px;margin-bottom:6px;">
        <input id="authEmail" type="email" placeholder="E-mail (para login online com Supabase)">
        <input id="authSenha" type="password" placeholder="Senha">
        <div style="display:flex;gap:8px;">
          <button id="btnCadastrar" class="btn-primary" style="flex:1;">Criar conta</button>
          <button id="btnEntrar" class="btn-outline" style="flex:1;">Entrar</button>
        </div>
        <button id="btnSair" class="btn-outline" style="margin-top:4px;display:none;">Sair</button>
        <small id="authStatus"></small>
        <small style="font-size:0.75rem;color:#6b7280;">
          <b>Modo atual:</b> se o Supabase estiver desligado na configura√ß√£o, o sistema usa apenas o navegador (localStorage).
        </small>
      </div>
    </div>

    <!-- APLICATIVO PRINCIPAL -->
    <div class="app" id="appContainer" style="display:none;">
      <header>
        <div>
          <h1>Controle de Compras</h1>
          <span>Meses ‚ûù Listas ‚ûù Itens, com carteiras, gr√°ficos e backup.</span>
        </div>
        <button class="btn-outline" id="btnLimparLista" title="Limpar apenas a lista atual">
          üßπ Limpar lista atual
        </button>
      </header>

      <!-- MES / LISTAS -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üìÜ</span> Meses e listas de compras
        </div>

        <div class="row-flex">
          <label for="selectMes">M√™s de refer√™ncia:</label>
          <select id="selectMes"></select>
          <button class="btn-outline" id="btnNovoMes">‚ûï Novo m√™s</button>
        </div>

        <div class="row-flex">
          <label for="selectLista">Lista dentro do m√™s:</label>
          <select id="selectLista"></select>
          <button class="btn-outline" id="btnNovaListaMes">‚ûï Nova lista neste m√™s</button>
        </div>

        <small style="font-size:0.75rem;color:#6b7280;">
          Exemplo: M√™s 11/2025 ‚Üí listas "Compra grande", "Reposi√ß√£o", "Churrasco".
        </small>
      </div>

      <!-- CARTEIRAS -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üëõ</span> Carteiras / formas de pagamento
        </div>

        <div class="row-flex">
          <label for="novaCarteiraNome">Nova carteira:</label>
          <input type="text" id="novaCarteiraNome" placeholder="Ex: Pix, Cr√©dito Nubank, D√©bito Caixa, VR, Dinheiro">
          <button class="btn-outline" id="btnAdicionarCarteira">‚ûï Adicionar carteira</button>
        </div>

        <small style="font-size:0.75rem;color:#6b7280;">
          As carteiras ficam dispon√≠veis para sele√ß√£o em cada item da lista.
        </small>

        <div id="listaCarteirasResumo" class="chips"></div>
      </div>

      <!-- OR√áAMENTO -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üí∞</span> Or√ßamento da lista atual
        </div>
        <div class="orcamento-box">
          <label>
            <input type="checkbox" id="usarOrcamento">
            Ativar controle de or√ßamento
          </label>
          <input
            type="number"
            id="valorOrcamento"
            placeholder="Valor dispon√≠vel (ex: 300,00)"
            step="0.01"
            min="0"
            disabled
          >
        </div>
        <small style="font-size:0.75rem;color:#6b7280;">
          Cada lista (dentro do m√™s) pode ter seu pr√≥prio or√ßamento, salvo localmente ou no banco.
        </small>
      </div>

      <!-- ITENS DA LISTA -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üõí</span> Itens da lista atual
        </div>

        <div class="form-grid">
          <div class="field field-produto">
            <label for="produto">Produto</label>
            <input type="text" id="produto" list="listaProdutos" placeholder="Ex: Arroz, Carne, Sab√£o em p√≥">
            <datalist id="listaProdutos"></datalist>
          </div>

          <div class="field field-categoria">
            <label for="categoria">Categoria</label>
            <input list="listaCategorias" id="categoria" placeholder="Ex: Hortifruti, Carne, Limpeza">
            <datalist id="listaCategorias">
              <option value="Hortifruti"></option>
              <option value="Carnes"></option>
              <option value="Padaria"></option>
              <option value="Bebidas"></option>
              <option value="Limpeza"></option>
              <option value="Higiene"></option>
              <option value="Mercearia"></option>
              <option value="Frios"></option>
            </datalist>
          </div>

          <div class="field field-carteira">
            <label for="carteiraItem">Carteira</label>
            <select id="carteiraItem"></select>
          </div>

          <div class="field field-qtde">
            <label for="quantidade">Quantidade</label>
            <input type="number" id="quantidade" step="0.01" min="0">
          </div>

          <div class="field field-unidade">
            <label for="unidade">Unidade</label>
            <select id="unidade">
              <option value="un">Unidade</option>
              <option value="kg">Kg</option>
              <option value="g">Gramas</option>
              <option value="L">Litros</option>
              <option value="cx">Caixa</option>
            </select>
          </div>

          <div class="field field-preco">
            <label for="preco">Pre√ßo por un/kg/L (R$)</label>
            <input type="number" id="preco" step="0.01" min="0">
          </div>

          <div class="field field-btn">
            <label>&nbsp;</label>
            <button class="btn-primary" id="btnAdicionar">‚ûï Adicionar item</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Produto</th>
                <th>Categoria</th>
                <th>Carteira</th>
                <th>Qtd</th>
                <th class="right">Pre√ßo</th>
                <th class="right">Total item</th>
                <th class="right"></th>
              </tr>
            </thead>
            <tbody id="tabelaItensBody"></tbody>
          </table>
        </div>

        <div class="table-actions">
          <span id="infoQuantidadeItens">Nenhum item adicionado ainda.</span>
          <span style="font-size:0.75rem;">Dica: use carteiras diferentes para ver o impacto de Pix, cr√©dito, VR etc.</span>
        </div>
      </div>

      <!-- RESUMO LISTA -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üìä</span> Resumo da lista atual
        </div>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-label">Total da lista</div>
            <div class="summary-value" id="totalCompra">R$ 0,00</div>
            <div class="summary-extra" id="summaryItens">0 itens</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Ticket m√©dio por item</div>
            <div class="summary-value" id="ticketMedio">R$ 0,00</div>
            <div class="summary-extra">Total √∑ n¬∫ de itens</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Maior gasto em um item</div>
            <div class="summary-value" id="maiorItem">R$ 0,00</div>
            <div class="summary-extra" id="maiorItemNome">‚Äì</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Categorias distintas</div>
            <div class="summary-value" id="qtdCategorias">0</div>
            <div class="summary-extra">Perfil de consumo</div>
          </div>
        </div>

        <div class="budget-bar-container" id="budgetContainer" style="display:none;">
          <div class="summary-label" style="margin-top:10px;">Utiliza√ß√£o do or√ßamento da lista</div>
          <div class="budget-bar-track">
            <div class="budget-bar-fill" id="budgetBar"></div>
          </div>
          <div class="budget-status" id="budgetStatus"></div>
        </div>
      </div>

      <!-- GR√ÅFICOS LISTA -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üìà</span> Gr√°ficos da lista atual
        </div>

        <div class="charts-grid">
          <div class="chart-card">
            <h3>Gastos por categoria</h3>
            <div class="chart-helper">Participa√ß√£o de cada categoria dentro da lista.</div>
            <canvas id="chartCategorias" height="220"></canvas>
          </div>
          <div class="chart-card">
            <h3>Top produtos</h3>
            <div class="chart-helper">At√© 5 produtos que mais pesam na lista.</div>
            <canvas id="chartTopProdutos" height="220"></canvas>
          </div>
        </div>
      </div>

      <!-- VIS√ÉO M√äS / GERAL -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üåé</span> Vis√£o geral por m√™s
        </div>

        <div class="summary-grid" style="margin-bottom:10px;">
          <div class="summary-card">
            <div class="summary-label">Total geral</div>
            <div class="summary-value" id="totalGeralMeses">R$ 0,00</div>
            <div class="summary-extra">Todos os meses</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Meses com dados</div>
            <div class="summary-value" id="qtdMeses">0</div>
            <div class="summary-extra"></div>
          </div>

          <div class="summary-card">
            <div class="summary-label">M√™s com maior gasto</div>
            <div class="summary-value" id="mesTopLabel">‚Äì</div>
            <div class="summary-extra" id="mesTopValor">R$ 0,00</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Listas totais</div>
            <div class="summary-value" id="qtdListasTotais">0</div>
            <div class="summary-extra"></div>
          </div>
        </div>

        <div class="chart-card">
          <h3>Totais por m√™s</h3>
          <div class="chart-helper">Soma de todas as listas em cada m√™s.</div>
          <canvas id="chartTotaisMeses" height="240"></canvas>
        </div>
      </div>

      <!-- VIS√ÉO POR CARTEIRA -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üí≥</span> Vis√£o por carteira
        </div>
        <div class="chart-card">
          <h3>Totais por carteira</h3>
          <div class="chart-helper">Uso de Pix, cr√©dito, d√©bito, VR etc., em todos os meses.</div>
          <canvas id="chartCarteiras" height="240"></canvas>
        </div>
      </div>

      <!-- BACKUP -->
      <div class="card">
        <div class="section-title">
          <span class="icon">üíæ</span> Backup de dados (JSON)
        </div>
        <p style="font-size:0.8rem;color:#9ca3af;margin-top:0;margin-bottom:8px;">
          Exporte um arquivo de backup (.json) para usar seus dados em outra m√°quina ou navegador.
        </p>
        <div class="row-flex">
          <button class="btn-outline" id="btnExportarBackup">‚¨áÔ∏è Exportar backup</button>
          <button class="btn-outline" id="btnImportarBackup">‚¨ÜÔ∏è Importar backup</button>
          <input type="file" id="inputImportarBackup" accept=".json,application/json" style="display:none;">
        </div>
        <small style="font-size:0.75rem;color:#6b7280;">
          O backup inclui meses, listas, itens e carteiras. No modo online, apenas complementa o banco.
        </small>
      </div>
    </div>
  </div>

  <!-- MODAL DE EDI√á√ÉO -->
  <div id="modalEdicao" class="modal-backdrop">
    <div class="modal-dialog">
      <h3 class="modal-title">Editar item</h3>

      <label class="edit-label">Produto</label>
      <input id="editProduto" class="edit-input">

      <label class="edit-label">Categoria</label>
      <input id="editCategoria" class="edit-input">

      <label class="edit-label">Carteira</label>
      <select id="editCarteira" class="edit-input"></select>

      <label class="edit-label">Quantidade</label>
      <input id="editQuantidade" type="number" step="0.01" min="0" class="edit-input">

      <label class="edit-label">Unidade</label>
      <select id="editUnidade" class="edit-input">
        <option value="un">Unidade</option>
        <option value="kg">Kg</option>
        <option value="g">Gramas</option>
        <option value="L">Litros</option>
        <option value="cx">Caixa</option>
      </select>

      <label class="edit-label">Pre√ßo un/kg/L (R$)</label>
      <input id="editPreco" type="number" step="0.01" min="0" class="edit-input">

      <div class="modal-actions">
        <button id="btnCancelarEdicao" class="btn-outline">Cancelar</button>
        <button id="btnSalvarEdicao" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <script>
  (function() {
    // ================== CONFIGURA√á√ÉO PROFISSIONAL ==================
    const CONFIG = {
      storageKey: 'controleComprasMeses_v2',
      useSupabase: false, // <<<<< Muda pra true quando for usar Supabase
      supabaseUrl: 'https://SEU-PROJETO.supabase.co',
      supabaseAnonKey: 'SUA-ANON-PUBLIC-KEY'
    };

    let supabaseClient = null;
    let usuarioAtual = null;

    if (CONFIG.useSupabase && window.supabase) {
      supabaseClient = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
    }

    // ================== DADOS SUGERIDOS ==================
    const produtosSugeridos = [
      { nome: 'Arroz', categoria: 'Mercearia' },
      { nome: 'Feij√£o', categoria: 'Mercearia' },
      { nome: 'Macarr√£o', categoria: 'Mercearia' },
      { nome: 'A√ß√∫car', categoria: 'Mercearia' },
      { nome: 'Sal', categoria: 'Mercearia' },
      { nome: '√ìleo de soja', categoria: 'Mercearia' },
      { nome: 'Caf√©', categoria: 'Mercearia' },
      { nome: 'Farinha de trigo', categoria: 'Mercearia' },
      { nome: 'Molho de tomate', categoria: 'Mercearia' },
      { nome: 'Leite', categoria: 'Bebidas' },
      { nome: 'Refrigerante', categoria: 'Bebidas' },
      { nome: '√Ågua mineral', categoria: 'Bebidas' },
      { nome: 'Suco de caixinha', categoria: 'Bebidas' },
      { nome: 'P√£o franc√™s', categoria: 'Padaria' },
      { nome: 'P√£o de forma', categoria: 'Padaria' },
      { nome: 'Bolo', categoria: 'Padaria' },
      { nome: 'Queijo mussarela', categoria: 'Frios' },
      { nome: 'Presunto', categoria: 'Frios' },
      { nome: 'Mortadela', categoria: 'Frios' },
      { nome: 'Frango inteiro', categoria: 'Carnes' },
      { nome: 'Coxa de frango', categoria: 'Carnes' },
      { nome: 'Peito de frango', categoria: 'Carnes' },
      { nome: 'Carne bovina (patinho)', categoria: 'Carnes' },
      { nome: 'Carne bovina (m√∫sculo)', categoria: 'Carnes' },
      { nome: 'Lingui√ßa', categoria: 'Carnes' },
      { nome: 'Tomate', categoria: 'Hortifruti' },
      { nome: 'Cebola', categoria: 'Hortifruti' },
      { nome: 'Alho', categoria: 'Hortifruti' },
      { nome: 'Batata', categoria: 'Hortifruti' },
      { nome: 'Cenoura', categoria: 'Hortifruti' },
      { nome: 'Banana', categoria: 'Hortifruti' },
      { nome: 'Ma√ß√£', categoria: 'Hortifruti' },
      { nome: 'Laranja', categoria: 'Hortifruti' },
      { nome: 'Sab√£o em p√≥', categoria: 'Limpeza' },
      { nome: 'Detergente', categoria: 'Limpeza' },
      { nome: 'Desinfetante', categoria: 'Limpeza' },
      { nome: 'Amaciante', categoria: 'Limpeza' },
      { nome: '√Ågua sanit√°ria', categoria: 'Limpeza' },
      { nome: 'Sabonete', categoria: 'Higiene' },
      { nome: 'Shampoo', categoria: 'Higiene' },
      { nome: 'Condicionador', categoria: 'Higiene' },
      { nome: 'Papel higi√™nico', categoria: 'Higiene' },
      { nome: 'Creme dental', categoria: 'Higiene' },
      { nome: 'Desodorante', categoria: 'Higiene' }
    ];

    // ================== ESTADO GLOBAL ==================
    let meses = [];
    let mesAtivoId = null;
    let listaAtivaId = null;
    let carteiras = [];
    let itemEditando = null;

    // ================== ELEMENTOS DOM ==================
    const authContainer = document.getElementById('authContainer');
    const appContainer = document.getElementById('appContainer');
    const authEmail = document.getElementById('authEmail');
    const authSenha = document.getElementById('authSenha');
    const btnCadastrar = document.getElementById('btnCadastrar');
    const btnEntrar = document.getElementById('btnEntrar');
    const btnSair = document.getElementById('btnSair');
    const authStatus = document.getElementById('authStatus');

    const selectMes = document.getElementById('selectMes');
    const selectLista = document.getElementById('selectLista');
    const btnNovoMes = document.getElementById('btnNovoMes');
    const btnNovaListaMes = document.getElementById('btnNovaListaMes');
    const btnLimparLista = document.getElementById('btnLimparLista');

    const usarOrcamento = document.getElementById('usarOrcamento');
    const valorOrcamentoInput = document.getElementById('valorOrcamento');

    const btnAdicionar = document.getElementById('btnAdicionar');
    const tabelaItensBody = document.getElementById('tabelaItensBody');

    const totalCompraSpan = document.getElementById('totalCompra');
    const summaryItensSpan = document.getElementById('summaryItens');
    const ticketMedioSpan = document.getElementById('ticketMedio');
    const maiorItemSpan = document.getElementById('maiorItem');
    const maiorItemNomeSpan = document.getElementById('maiorItemNome');
    const qtdCategoriasSpan = document.getElementById('qtdCategorias');
    const infoQuantidadeItensSpan = document.getElementById('infoQuantidadeItens');

    const budgetContainer = document.getElementById('budgetContainer');
    const budgetBar = document.getElementById('budgetBar');
    const budgetStatus = document.getElementById('budgetStatus');

    const totalGeralMesesSpan = document.getElementById('totalGeralMeses');
    const qtdMesesSpan = document.getElementById('qtdMeses');
    const mesTopLabelSpan = document.getElementById('mesTopLabel');
    const mesTopValorSpan = document.getElementById('mesTopValor');
    const qtdListasTotaisSpan = document.getElementById('qtdListasTotais');

    const modalEdicao = document.getElementById('modalEdicao');
    const editProduto = document.getElementById('editProduto');
    const editCategoria = document.getElementById('editCategoria');
    const editCarteira = document.getElementById('editCarteira');
    const editQuantidade = document.getElementById('editQuantidade');
    const editUnidade = document.getElementById('editUnidade');
    const editPreco = document.getElementById('editPreco');
    const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
    const btnSalvarEdicao = document.getElementById('btnSalvarEdicao');

    const inputProduto = document.getElementById('produto');
    const inputCategoria = document.getElementById('categoria');
    const datalistProdutos = document.getElementById('listaProdutos');
    const selectCarteiraItem = document.getElementById('carteiraItem');

    const inputNovaCarteiraNome = document.getElementById('novaCarteiraNome');
    const btnAdicionarCarteira = document.getElementById('btnAdicionarCarteira');
    const listaCarteirasResumo = document.getElementById('listaCarteirasResumo');

    const btnExportarBackup = document.getElementById('btnExportarBackup');
    const btnImportarBackup = document.getElementById('btnImportarBackup');
    const inputImportarBackup = document.getElementById('inputImportarBackup');

    // GR√ÅFICOS
    let chartCategorias = null;
    let chartTopProdutos = null;
    let chartTotaisMeses = null;
    let chartCarteiras = null;

    // ================== FUN√á√ïES AUXILIARES ==================
    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function formatarQuantidade(quantidade, unidade) {
      if (unidade === 'g') return quantidade.toFixed(0) + ' g';
      if (unidade === 'kg') return quantidade.toFixed(3).replace('.', ',') + ' kg';
      if (unidade === 'L') return quantidade.toFixed(3).replace('.', ',') + ' L';
      if (unidade === 'cx') return quantidade.toFixed(2).replace('.', ',') + ' cx';
      return quantidade.toFixed(2).replace('.', ',') + ' un';
    }

    function idMesAtual() {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = String(hoje.getMonth() + 1).padStart(2, '0');
      return `${ano}-${mes}`;
    }

    function labelMes(idMes) {
      const [ano, mes] = idMes.split('-');
      return `${mes}/${ano}`;
    }

    function inicializarCarteirasPadrao() {
      return [
        { id: 'c1', nome: 'Dinheiro' },
        { id: 'c2', nome: 'Pix' },
        { id: 'c3', nome: 'Cr√©dito' },
        { id: 'c4', nome: 'D√©bito' },
        { id: 'c5', nome: 'VR' },
        { id: 'c6', nome: 'VA' }
      ];
    }

    function getMesAtivo() {
      return meses.find(m => m.id === mesAtivoId) || null;
    }

    function getListaAtiva() {
      const mes = getMesAtivo();
      if (!mes) return null;
      return mes.listas.find(l => l.id === listaAtivaId) || null;
    }

    function nomeCarteiraPorId(id) {
      const c = carteiras.find(x => x.id === id);
      return c ? c.nome : 'Sem carteira';
    }

    // ================== PERSIST√äNCIA LOCAL ==================
    function salvarEstadoLocal() {
      const data = { meses, mesAtivoId, listaAtivaId, carteiras };
      localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
    }

    function carregarEstadoLocal() {
      const raw = localStorage.getItem(CONFIG.storageKey);
      if (!raw) {
        const id = idMesAtual();
        const mesPadrao = {
          id,
          nome: labelMes(id),
          listas: [{
            id: 'lista-1',
            nome: 'Lista padr√£o',
            itens: [],
            proximoId: 1,
            usarOrcamento: false,
            valorOrcamento: ''
          }]
        };
        meses = [mesPadrao];
        mesAtivoId = id;
        listaAtivaId = mesPadrao.listas[0].id;
        carteiras = inicializarCarteirasPadrao();
        salvarEstadoLocal();
        return;
      }

      try {
        const data = JSON.parse(raw);
        meses = Array.isArray(data.meses) ? data.meses : [];
        mesAtivoId = data.mesAtivoId || (meses[0] && meses[0].id);
        listaAtivaId = data.listaAtivaId || (getMesAtivo() && getMesAtivo().listas[0].id);
        carteiras = Array.isArray(data.carteiras) && data.carteiras.length
          ? data.carteiras
          : inicializarCarteirasPadrao();
      } catch {
        localStorage.removeItem(CONFIG.storageKey);
        carregarEstadoLocal();
      }
    }

    // ================== PERSIST√äNCIA SUPABASE (OPCIONAL) ==================
    async function salvarEstado() {
      // sempre salva local tamb√©m
      salvarEstadoLocal();

      if (!CONFIG.useSupabase || !supabaseClient || !usuarioAtual) return;

      const state = { meses, mesAtivoId, listaAtivaId, carteiras };
      const { error } = await supabaseClient
        .from('shopping_states')
        .upsert({ user_id: usuarioAtual.id, data: state });

      if (error) console.error('Erro ao salvar no Supabase:', error.message);
    }

    async function carregarEstadoBD() {
      if (!CONFIG.useSupabase || !supabaseClient || !usuarioAtual) {
        carregarEstadoLocal();
        return;
      }

      const { data, error } = await supabaseClient
        .from('shopping_states')
        .select('data')
        .eq('user_id', usuarioAtual.id)
        .maybeSingle();

      if (error) {
        console.error('Erro ao carregar do Supabase:', error.message);
        carregarEstadoLocal();
        return;
      }

      if (data && data.data) {
        const state = data.data;
        meses = state.meses || [];
        mesAtivoId = state.mesAtivoId || (meses[0] && meses[0].id);
        listaAtivaId = state.listaAtivaId || (getMesAtivo() && getMesAtivo().listas[0].id);
        carteiras = state.carteiras && state.carteiras.length
          ? state.carteiras
          : inicializarCarteirasPadrao();
      } else {
        carregarEstadoLocal();
        await salvarEstado();
      }
    }

    // ================== AUTH SUPABASE ==================
    async function cadastrarUsuario() {
      if (!CONFIG.useSupabase || !supabaseClient) {
        authStatus.textContent = 'Supabase est√° desativado na configura√ß√£o.';
        return;
      }
      const email = authEmail.value.trim();
      const senha = authSenha.value.trim();
      if (!email || !senha) {
        authStatus.textContent = 'Informe e-mail e senha.';
        return;
      }
      authStatus.textContent = 'Criando conta...';

      const { error } = await supabaseClient.auth.signUp({ email, password: senha });
      authStatus.textContent = error
        ? 'Erro ao criar conta: ' + error.message
        : 'Conta criada. Verifique seu e-mail (se exigido no projeto).';
    }

    async function entrarUsuario() {
      if (!CONFIG.useSupabase || !supabaseClient) {
        authStatus.textContent = 'Supabase desativado. Sistema est√° em modo local (sem login).';
        return;
      }
      const email = authEmail.value.trim();
      const senha = authSenha.value.trim();
      if (!email || !senha) {
        authStatus.textContent = 'Informe e-mail e senha.';
        return;
      }
      authStatus.textContent = 'Entrando...';

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password: senha
      });

      if (error) {
        authStatus.textContent = 'Erro ao entrar: ' + error.message;
        return;
      }

      usuarioAtual = data.user;
      authStatus.textContent = 'Login realizado.';
      await aposLogin();
    }

    async function sairUsuario() {
      if (CONFIG.useSupabase && supabaseClient) {
        await supabaseClient.auth.signOut();
      }
      usuarioAtual = null;
      appContainer.style.display = 'none';
      authContainer.style.display = 'block';
      btnSair.style.display = 'none';
      authStatus.textContent = 'Sess√£o encerrada.';
    }

    async function aposLogin() {
      authContainer.style.display = 'none';
      appContainer.style.display = 'block';
      btnSair.style.display = CONFIG.useSupabase ? 'inline-flex' : 'none';
      await carregarEstadoBD();
      atualizarSelectMeses();
      atualizarSelectListas();
      atualizarSelectCarteiras();
      atualizarResumoCarteirasChips();
      carregarListaNaUI();
    }

    // ================== UI: AUTOCOMPLETE PRODUTOS ==================
    function inicializarListaProdutos() {
      datalistProdutos.innerHTML = '';
      produtosSugeridos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nome;
        datalistProdutos.appendChild(opt);
      });
    }

    function sugerirCategoriaParaProduto(nomeProduto) {
      const nome = (nomeProduto || '').trim().toLowerCase();
      if (!nome) return;
      const encontrado = produtosSugeridos.find(p => p.nome.toLowerCase() === nome);
      if (encontrado && !inputCategoria.value.trim()) {
        inputCategoria.value = encontrado.categoria;
      }
    }

    inputProduto.addEventListener('change', () => {
      sugerirCategoriaParaProduto(inputProduto.value);
    });
    inputProduto.addEventListener('blur', () => {
      sugerirCategoriaParaProduto(inputProduto.value);
    });

    // ================== UI: CARTEIRAS ==================
    function atualizarSelectCarteiras() {
      selectCarteiraItem.innerHTML = '';
      editCarteira.innerHTML = '';

      const optNenhuma = document.createElement('option');
      optNenhuma.value = '';
      optNenhuma.textContent = 'Sem carteira';
      selectCarteiraItem.appendChild(optNenhuma);
      const optNenhuma2 = optNenhuma.cloneNode(true);
      editCarteira.appendChild(optNenhuma2);

      carteiras.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nome;
        selectCarteiraItem.appendChild(opt);

        const opt2 = document.createElement('option');
        opt2.value = c.id;
        opt2.textContent = c.nome;
        editCarteira.appendChild(opt2);
      });
    }

    function atualizarResumoCarteirasChips() {
      listaCarteirasResumo.innerHTML = '';
      if (!carteiras.length) {
        const span = document.createElement('span');
        span.textContent = 'Nenhuma carteira cadastrada.';
        span.style.fontSize = '0.8rem';
        span.style.color = '#6b7280';
        listaCarteirasResumo.appendChild(span);
        return;
      }
      carteiras.forEach(c => {
        const chip = document.createElement('div');
        chip.classList.add('chip');
        chip.textContent = c.nome;
        listaCarteirasResumo.appendChild(chip);
      });
    }

    function adicionarCarteira() {
      const nome = inputNovaCarteiraNome.value.trim();
      if (!nome) {
        alert('Informe o nome da carteira (ex: Pix, Cr√©dito Nubank, VR).');
        return;
      }
      const id = 'c' + Date.now();
      carteiras.push({ id, nome });
      inputNovaCarteiraNome.value = '';
      atualizarSelectCarteiras();
      atualizarResumoCarteirasChips();
      salvarEstado();
    }

    // ================== UI: MESES E LISTAS ==================
    function atualizarSelectMeses() {
      selectMes.innerHTML = '';
      meses.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.nome || labelMes(m.id);
        if (m.id === mesAtivoId) opt.selected = true;
        selectMes.appendChild(opt);
      });
    }

    function atualizarSelectListas() {
      const mes = getMesAtivo();
      selectLista.innerHTML = '';
      if (!mes || !mes.listas.length) {
        listaAtivaId = null;
        return;
      }
      mes.listas.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.nome;
        if (l.id === listaAtivaId) opt.selected = true;
        selectLista.appendChild(opt);
      });
      if (!listaAtivaId) listaAtivaId = mes.listas[0].id;
    }

    function carregarListaNaUI() {
      const lista = getListaAtiva();
      if (!lista) {
        tabelaItensBody.innerHTML = '';
        infoQuantidadeItensSpan.textContent = 'Nenhuma lista selecionada.';
        totalCompraSpan.textContent = 'R$ 0,00';
        summaryItensSpan.textContent = '0 itens';
        ticketMedioSpan.textContent = 'R$ 0,00';
        maiorItemSpan.textContent = 'R$ 0,00';
        maiorItemNomeSpan.textContent = '‚Äì';
        qtdCategoriasSpan.textContent = '0';
        budgetContainer.style.display = 'none';
        atualizarGraficos();
        atualizarGraficosGerais();
        return;
      }

      usarOrcamento.checked = !!lista.usarOrcamento;
      valorOrcamentoInput.disabled = !lista.usarOrcamento;
      valorOrcamentoInput.value = lista.valorOrcamento || '';

      renderizarTabela();
      atualizarResumo();
    }

    // ================== LISTA: RENDER, RESUMO ==================
    function renderizarTabela() {
      const lista = getListaAtiva();
      if (!lista) return;
      const itens = lista.itens || [];
      tabelaItensBody.innerHTML = '';

      itens.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const tdSeq = document.createElement('td');
        tdSeq.textContent = idx + 1;

        const tdProd = document.createElement('td');
        tdProd.textContent = item.produto;

        const tdCat = document.createElement('td');
        const catLabel = item.categoria && item.categoria.trim()
          ? item.categoria.trim()
          : 'Sem categoria';
        const spanCat = document.createElement('span');
        spanCat.classList.add('tag');
        if (!item.categoria) spanCat.classList.add('tag-default');
        spanCat.textContent = catLabel;
        tdCat.appendChild(spanCat);

        const tdCart = document.createElement('td');
        const spanCart = document.createElement('span');
        spanCart.classList.add('tag');
        spanCart.textContent = item.carteiraId ? nomeCarteiraPorId(item.carteiraId) : 'Sem carteira';
        tdCart.appendChild(spanCart);

        const tdQtd = document.createElement('td');
        tdQtd.textContent = formatarQuantidade(item.quantidade, item.unidade);

        const tdPreco = document.createElement('td');
        tdPreco.classList.add('right');
        tdPreco.textContent = formatarMoeda(item.preco);

        const tdTotal = document.createElement('td');
        tdTotal.classList.add('right');
        tdTotal.textContent = formatarMoeda(item.totalItem);

        const tdAcoes = document.createElement('td');
        tdAcoes.classList.add('right');

        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.classList.add('btn-small', 'btn-outline');
        btnEditar.style.marginRight = '6px';
        btnEditar.addEventListener('click', () => abrirEditor(item.id));

        const btnExcluir = document.createElement('button');
        btnExcluir.textContent = 'Excluir';
        btnExcluir.classList.add('btn-small', 'btn-danger');
        btnExcluir.addEventListener('click', () => removerItem(item.id));

        tdAcoes.appendChild(btnEditar);
        tdAcoes.appendChild(btnExcluir);

        tr.appendChild(tdSeq);
        tr.appendChild(tdProd);
        tr.appendChild(tdCat);
        tr.appendChild(tdCart);
        tr.appendChild(tdQtd);
        tr.appendChild(tdPreco);
        tr.appendChild(tdTotal);
        tr.appendChild(tdAcoes);

        tabelaItensBody.appendChild(tr);
      });

      if (!itens.length) {
        infoQuantidadeItensSpan.textContent = 'Nenhum item adicionado ainda.';
      } else if (itens.length === 1) {
        infoQuantidadeItensSpan.textContent = '1 item na lista.';
      } else {
        infoQuantidadeItensSpan.textContent = `${itens.length} itens na lista.`;
      }
    }

    function atualizarResumo() {
      const lista = getListaAtiva();
      if (!lista) return;
      const itens = lista.itens || [];
      const total = itens.reduce((s, i) => s + i.totalItem, 0);

      totalCompraSpan.textContent = formatarMoeda(total);
      summaryItensSpan.textContent = `${itens.length} item${itens.length === 1 ? '' : 's'}`;

      const ticketMedio = itens.length ? total / itens.length : 0;
      ticketMedioSpan.textContent = formatarMoeda(ticketMedio);

      if (itens.length) {
        const maior = itens.reduce((acc, i) => i.totalItem > acc.totalItem ? i : acc, itens[0]);
        maiorItemSpan.textContent = formatarMoeda(maior.totalItem);
        maiorItemNomeSpan.textContent = maior.produto;
      } else {
        maiorItemSpan.textContent = 'R$ 0,00';
        maiorItemNomeSpan.textContent = '‚Äì';
      }

      const catSet = new Set(
        itens.map(i => (i.categoria && i.categoria.trim()) ? i.categoria.trim() : 'Sem categoria')
      );
      qtdCategoriasSpan.textContent = itens.length ? catSet.size : 0;

      // or√ßamento
      if (lista.usarOrcamento && lista.valorOrcamento) {
        const orcamento = parseFloat(String(lista.valorOrcamento).replace(',', '.')) || 0;
        if (orcamento > 0) {
          budgetContainer.style.display = 'block';
          const perc = Math.min(100, (total / orcamento) * 100);
          budgetBar.style.width = perc.toFixed(1) + '%';
          const diff = orcamento - total;
          if (diff > 0) {
            budgetStatus.textContent = `Voc√™ ainda pode gastar ${formatarMoeda(diff)} (${perc.toFixed(1)}% do or√ßamento).`;
            budgetStatus.className = 'budget-status budget-ok';
          } else if (diff === 0) {
            budgetStatus.textContent = `Voc√™ atingiu exatamente o or√ßamento (${perc.toFixed(1)}% utilizado).`;
            budgetStatus.className = 'budget-status budget-alerta';
          } else {
            budgetStatus.textContent = `Voc√™ estourou o or√ßamento em ${formatarMoeda(Math.abs(diff))} (${perc.toFixed(1)}% do or√ßamento).`;
            budgetStatus.className = 'budget-status budget-estourado';
          }
        } else {
          budgetContainer.style.display = 'none';
        }
      } else {
        budgetContainer.style.display = 'none';
      }

      atualizarGraficos();
      atualizarGraficosGerais();
      salvarEstado();
    }

    // ================== GR√ÅFICOS ==================
    function atualizarGraficos() {
      const lista = getListaAtiva();
      const itens = lista ? (lista.itens || []) : [];

      // categorias
      const gastosPorCategoria = {};
      itens.forEach(i => {
        const c = (i.categoria && i.categoria.trim()) ? i.categoria.trim() : 'Sem categoria';
        gastosPorCategoria[c] = (gastosPorCategoria[c] || 0) + i.totalItem;
      });
      const labelsCat = Object.keys(gastosPorCategoria);
      const valuesCat = Object.values(gastosPorCategoria);

      const ctxCat = document.getElementById('chartCategorias').getContext('2d');
      if (chartCategorias) chartCategorias.destroy();
      chartCategorias = new Chart(ctxCat, {
        type: 'doughnut',
        data: { labels: labelsCat, datasets: [{ data: valuesCat }] },
        options: {
          plugins: {
            legend: { position: 'bottom', labels: { color: '#e5e7eb', font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${formatarMoeda(ctx.raw || 0)}`
              }
            }
          }
        }
      });

      // top produtos
      const top = [...itens].sort((a, b) => b.totalItem - a.totalItem).slice(0, 5);
      const labelsTop = top.map(i => i.produto);
      const valuesTop = top.map(i => i.totalItem);
      const ctxTop = document.getElementById('chartTopProdutos').getContext('2d');
      if (chartTopProdutos) chartTopProdutos.destroy();
      chartTopProdutos = new Chart(ctxTop, {
        type: 'bar',
        data: { labels: labelsTop, datasets: [{ data: valuesTop }] },
        options: {
          scales: {
            x: { ticks: { color: '#e5e7eb', font: { size: 11 } } },
            y: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 },
                callback: v => formatarMoeda(v)
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => formatarMoeda(ctx.raw || 0) } }
          }
        }
      });
    }

    function atualizarGraficosGerais() {
      const labelsMes = [];
      const valuesMes = [];
      let totalGeral = 0;
      let qtdListasTotais = 0;
      const totaisCarteiras = {};

      meses.forEach(m => {
        let totalMes = 0;
        (m.listas || []).forEach(l => {
          qtdListasTotais++;
          (l.itens || []).forEach(i => {
            totalMes += i.totalItem;
            const idC = i.carteiraId || 'sem';
            totaisCarteiras[idC] = (totaisCarteiras[idC] || 0) + i.totalItem;
          });
        });
        labelsMes.push(m.nome || labelMes(m.id));
        valuesMes.push(totalMes);
        totalGeral += totalMes;
      });

      totalGeralMesesSpan.textContent = formatarMoeda(totalGeral);
      qtdMesesSpan.textContent = meses.length;
      qtdListasTotaisSpan.textContent = qtdListasTotais;

      if (meses.length) {
        let idx = 0;
        let max = valuesMes[0] || 0;
        for (let i = 1; i < valuesMes.length; i++) {
          if (valuesMes[i] > max) { max = valuesMes[i]; idx = i; }
        }
        mesTopLabelSpan.textContent = labelsMes[idx];
        mesTopValorSpan.textContent = formatarMoeda(max);
      } else {
        mesTopLabelSpan.textContent = '‚Äì';
        mesTopValorSpan.textContent = 'R$ 0,00';
      }

      const ctxMes = document.getElementById('chartTotaisMeses').getContext('2d');
      if (chartTotaisMeses) chartTotaisMeses.destroy();
      chartTotaisMeses = new Chart(ctxMes, {
        type: 'bar',
        data: { labels: labelsMes, datasets: [{ data: valuesMes }] },
        options: {
          scales: {
            x: { ticks: { color: '#e5e7eb', font: { size: 11 } } },
            y: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 },
                callback: v => formatarMoeda(v)
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => formatarMoeda(ctx.raw || 0) } }
          }
        }
      });

      const labelsC = [];
      const valuesC = [];
      Object.keys(totaisCarteiras).forEach(id => {
        labelsC.push(id === 'sem' ? 'Sem carteira' : nomeCarteiraPorId(id));
        valuesC.push(totaisCarteiras[id]);
      });
      const ctxC = document.getElementById('chartCarteiras').getContext('2d');
      if (chartCarteiras) chartCarteiras.destroy();
      chartCarteiras = new Chart(ctxC, {
        type: 'bar',
        data: { labels: labelsC, datasets: [{ data: valuesC }] },
        options: {
          scales: {
            x: { ticks: { color: '#e5e7eb', font: { size: 11 } } },
            y: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 },
                callback: v => formatarMoeda(v)
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => formatarMoeda(ctx.raw || 0) } }
          }
        }
      });
    }

    // ================== ITENS: CRUD ==================
    function adicionarItem() {
      const lista = getListaAtiva();
      if (!lista) return;
      const produto = inputProduto.value.trim();
      const categoria = inputCategoria.value.trim();
      const carteiraId = selectCarteiraItem.value || null;
      const qtdStr = document.getElementById('quantidade').value;
      const precoStr = document.getElementById('preco').value;
      const unidade = document.getElementById('unidade').value;

      const quantidade = parseFloat(String(qtdStr).replace(',', '.'));
      const preco = parseFloat(String(precoStr).replace(',', '.'));

      if (!produto) return alert('Informe o nome do produto.');
      if (!quantidade || quantidade <= 0) return alert('Informe uma quantidade v√°lida.');
      if (!preco || preco <= 0) return alert('Informe um pre√ßo v√°lido.');

      const totalItem = unidade === 'g'
        ? (quantidade / 1000) * preco
        : quantidade * preco;

      if (!lista.proximoId) lista.proximoId = 1;
      const item = {
        id: lista.proximoId++,
        produto,
        categoria,
        quantidade,
        unidade,
        preco,
        totalItem,
        carteiraId
      };

      lista.itens.push(item);
      inputProduto.value = '';
      inputCategoria.value = '';
      document.getElementById('quantidade').value = '';
      document.getElementById('preco').value = '';
      inputProduto.focus();

      renderizarTabela();
      atualizarResumo();
    }

    function removerItem(id) {
      const lista = getListaAtiva();
      if (!lista) return;
      lista.itens = lista.itens.filter(i => i.id !== id);
      renderizarTabela();
      atualizarResumo();
    }

    function limparLista() {
      const lista = getListaAtiva();
      if (!lista) return;
      if (!confirm(`Limpar todos os itens e o or√ßamento da lista "${lista.nome}"?`)) return;
      lista.itens = [];
      lista.proximoId = 1;
      lista.usarOrcamento = false;
      lista.valorOrcamento = '';
      carregarListaNaUI();
      salvarEstado();
    }

    // ================== EDI√á√ÉO DE ITEM ==================
    function abrirEditor(id) {
      const lista = getListaAtiva();
      if (!lista) return;
      const item = lista.itens.find(i => i.id === id);
      if (!item) return;
      itemEditando = item;

      editProduto.value = item.produto;
      editCategoria.value = item.categoria || '';
      editQuantidade.value = item.quantidade;
      editUnidade.value = item.unidade;
      editPreco.value = item.preco;
      editCarteira.value = item.carteiraId || '';

      modalEdicao.style.display = 'flex';
    }

    function fecharEditor() {
      modalEdicao.style.display = 'none';
      itemEditando = null;
    }

    // ================== BACKUP ==================
    function exportarBackup() {
      salvarEstadoLocal();
      const raw = localStorage.getItem(CONFIG.storageKey);
      const blob = new Blob([raw], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const hoje = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `compras-backup-${hoje}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importarBackup(arquivo) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data || !Array.isArray(data.meses)) {
            alert('Arquivo de backup inv√°lido.');
            return;
          }
          meses = data.meses;
          mesAtivoId = data.mesAtivoId || (meses[0] && meses[0].id);
          listaAtivaId = data.listaAtivaId || (getMesAtivo() && getMesAtivo().listas[0].id);
          carteiras = Array.isArray(data.carteiras) && data.carteiras.length
            ? data.carteiras
            : inicializarCarteirasPadrao();
          salvarEstadoLocal();
          atualizarSelectMeses();
          atualizarSelectListas();
          atualizarSelectCarteiras();
          atualizarResumoCarteirasChips();
          carregarListaNaUI();
          alert('Backup importado com sucesso.');
        } catch (err) {
          console.error(err);
          alert('Erro ao ler o arquivo de backup.');
        }
      };
      reader.readAsText(arquivo, 'utf-8');
    }

    // ================== EVENTOS ==================
    btnAdicionar.addEventListener('click', e => {
      e.preventDefault();
      adicionarItem();
    });

    document.getElementById('preco').addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adicionarItem();
      }
    });

    btnLimparLista.addEventListener('click', e => {
      e.preventDefault();
      limparLista();
    });

    usarOrcamento.addEventListener('change', () => {
      const lista = getListaAtiva();
      if (!lista) return;
      lista.usarOrcamento = usarOrcamento.checked;
      if (!lista.usarOrcamento) {
        lista.valorOrcamento = '';
        valorOrcamentoInput.value = '';
      }
      valorOrcamentoInput.disabled = !lista.usarOrcamento;
      atualizarResumo();
    });

    valorOrcamentoInput.addEventListener('input', () => {
      const lista = getListaAtiva();
      if (!lista) return;
      lista.valorOrcamento = valorOrcamentoInput.value;
      atualizarResumo();
    });

    btnNovoMes.addEventListener('click', () => {
      const hoje = new Date();
      const anoDefault = hoje.getFullYear();
      const mesDefault = String(hoje.getMonth() + 1).padStart(2, '0');
      const input = prompt('Informe o m√™s/ano no formato MM/AAAA:', `${mesDefault}/${anoDefault}`);
      if (!input) return;
      const match = input.match(/^(\d{2})\/(\d{4})$/);
      if (!match) return alert('Formato inv√°lido. Use MM/AAAA.');

      const mes = match[1];
      const ano = match[2];
      const id = `${ano}-${mes}`;
      if (meses.some(m => m.id === id)) {
        return alert('Esse m√™s j√° existe. Selecione no campo de m√™s.');
      }

      const novoMes = {
        id,
        nome: `${mes}/${ano}`,
        listas: [{
          id: 'lista-1',
          nome: 'Lista padr√£o',
          itens: [],
          proximoId: 1,
          usarOrcamento: false,
          valorOrcamento: ''
        }]
      };
      meses.push(novoMes);
      mesAtivoId = id;
      listaAtivaId = novoMes.listas[0].id;
      atualizarSelectMeses();
      atualizarSelectListas();
      carregarListaNaUI();
      salvarEstado();
    });

    btnNovaListaMes.addEventListener('click', () => {
      const mes = getMesAtivo();
      if (!mes) return;
      const nome = prompt('Nome da nova lista para este m√™s:', 'Nova lista');
      if (!nome || !nome.trim()) return;
      const id = 'lista-' + Date.now();
      mes.listas.push({
        id,
        nome: nome.trim(),
        itens: [],
        proximoId: 1,
        usarOrcamento: false,
        valorOrcamento: ''
      });
      listaAtivaId = id;
      atualizarSelectListas();
      carregarListaNaUI();
      salvarEstado();
    });

    selectMes.addEventListener('change', () => {
      mesAtivoId = selectMes.value;
      const mes = getMesAtivo();
      listaAtivaId = mes && mes.listas.length ? mes.listas[0].id : null;
      atualizarSelectListas();
      carregarListaNaUI();
      salvarEstado();
    });

    selectLista.addEventListener('change', () => {
      listaAtivaId = selectLista.value;
      carregarListaNaUI();
      salvarEstado();
    });

    btnAdicionarCarteira.addEventListener('click', e => {
      e.preventDefault();
      adicionarCarteira();
    });

    inputNovaCarteiraNome.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adicionarCarteira();
      }
    });

    btnExportarBackup.addEventListener('click', () => exportarBackup());
    btnImportarBackup.addEventListener('click', () => inputImportarBackup.click());
    inputImportarBackup.addEventListener('change', () => {
      const arq = inputImportarBackup.files[0];
      if (!arq) return;
      importarBackup(arq);
      inputImportarBackup.value = '';
    });

    // Modal edi√ß√£o
    btnCancelarEdicao.addEventListener('click', () => fecharEditor());
    btnSalvarEdicao.addEventListener('click', () => {
      if (!itemEditando) return;
      const prod = editProduto.value.trim();
      const cat = editCategoria.value.trim();
      const qtd = parseFloat(String(editQuantidade.value).replace(',', '.'));
      const und = editUnidade.value;
      const preco = parseFloat(String(editPreco.value).replace(',', '.'));
      const carteiraId = editCarteira.value || null;
      if (!prod || !qtd || qtd <= 0 || !preco || preco <= 0) {
        return alert('Preencha os campos corretamente.');
      }
      const totalItem = und === 'g'
        ? (qtd / 1000) * preco
        : qtd * preco;
      itemEditando.produto = prod;
      itemEditando.categoria = cat;
      itemEditando.quantidade = qtd;
      itemEditando.unidade = und;
      itemEditando.preco = preco;
      itemEditando.totalItem = totalItem;
      itemEditando.carteiraId = carteiraId;
      renderizarTabela();
      atualizarResumo();
      fecharEditor();
    });

    modalEdicao.addEventListener('click', e => {
      if (e.target === modalEdicao) fecharEditor();
    });

    // Auth buttons
    btnCadastrar.addEventListener('click', e => {
      e.preventDefault();
      cadastrarUsuario();
    });

    btnEntrar.addEventListener('click', e => {
      e.preventDefault();
      entrarUsuario();
    });

    btnSair.addEventListener('click', e => {
      e.preventDefault();
      sairUsuario();
    });

    // ================== INICIALIZA√á√ÉO GLOBAL ==================
    (async function init() {
      inicializarListaProdutos();

      if (CONFIG.useSupabase && supabaseClient) {
        const { data } = await supabaseClient.auth.getSession();
        if (data.session && data.session.user) {
          usuarioAtual = data.session.user;
          authStatus.textContent = 'Sess√£o restaurada.';
          await aposLogin();
          return;
        } else {
          authContainer.style.display = 'block';
          appContainer.style.display = 'none';
          return;
        }
      }

      // modo local (sem Supabase)
      authStatus.textContent = 'Modo local: os dados ficam apenas neste navegador.';
      btnCadastrar.style.display = 'none';
      btnEntrar.style.display = 'none';
      btnSair.style.display = 'none';
      authEmail.style.display = 'none';
      authSenha.style.display = 'none';

      authContainer.style.display = 'none';
      appContainer.style.display = 'block';

      carregarEstadoLocal();
      atualizarSelectMeses();
      atualizarSelectListas();
      carteiras = carteiras && carteiras.length ? carteiras : inicializarCarteirasPadrao();
      atualizarSelectCarteiras();
      atualizarResumoCarteirasChips();
      carregarListaNaUI();
    })();
  })();
  </script>
</body>
</html>
