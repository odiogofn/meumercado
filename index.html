<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Compras - Meses, Listas e Carteiras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background: #0f172a;
      color: #e5e7eb;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 10px;
    }

    header h1 {
      margin: 0;
      font-size: 1.7rem;
      color: #f9fafb;
    }

    header span {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .card {
      background: #020617;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title span.icon {
      font-size: 1.1rem;
    }

    .row-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .row-flex label {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .row-flex select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .row-flex input[type="text"] {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .orcamento-box {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .orcamento-box label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .orcamento-box input[type="number"] {
      width: 160px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }

    .orcamento-box input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 2fr 1.4fr 1.4fr 1fr 1fr 1.2fr auto;
      gap: 10px;
      margin-top: 12px;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .field input::placeholder {
      color: #6b7280;
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #0f172a;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-outline {
      background: transparent;
      color: #9ca3af;
      border-radius: 999px;
      border: 1px solid #4b5563;
    }

    .btn-outline:hover {
      background: #111827;
      color: #e5e7eb;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .btn-danger {
      background: #ef4444;
      color: #f9fafb;
    }

    .btn-danger:hover {
      filter: brightness(1.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 6px;
      font-size: 0.85rem;
      border-bottom: 1px solid #111827;
    }

    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td {
      color: #e5e7eb;
    }

    .right { text-align: right; }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #1f2937;
    }

    .tag-default { background: #0f172a; }

    .table-wrapper {
      max-height: 280px;
      overflow: auto;
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #111827;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-card {
      background: #020617;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid #111827;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .summary-value {
      font-size: 1rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .summary-extra {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .budget-bar-container { margin-top: 8px; }

    .budget-bar-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .budget-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      transition: width 0.3s ease;
    }

    .budget-status {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .budget-ok { color: #22c55e; }
    .budget-alerta { color: #eab308; }
    .budget-estourado { color: #ef4444; }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
      gap: 12px;
      margin-top: 10px;
    }

    .chart-card {
      background: #020617;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #111827;
    }

    .chart-card h3 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .chart-helper {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .table-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 10px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* MODAL EDI√á√ÉO */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-dialog {
      background: #020617;
      padding: 20px;
      width: 340px;
      max-width: 95%;
      border-radius: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 0 20px rgba(0,0,0,0.45);
    }

    .modal-title {
      margin: 0 0 12px 0;
      color: #e5e7eb;
      font-size: 1rem;
      font-weight: 600;
    }

    .edit-label {
      color: #9ca3af;
      font-size: 0.8rem;
      display: block;
      margin-bottom: 2px;
    }

    .edit-input {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    .edit-input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      gap: 10px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      padding: 3px 10px;
      border-radius: 999px;
      background: #111827;
      font-size: 0.75rem;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }

    @media (max-width: 900px) {
      .form-grid {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "produto produto"
          "categoria categoria"
          "carteira carteira"
          "qtde unidade"
          "preco preco"
          "btn btn";
      }
      .field-produto { grid-area: produto; }
      .field-categoria { grid-area: categoria; }
      .field-carteira { grid-area: carteira; }
      .field-qtde { grid-area: qtde; }
      .field-unidade { grid-area: unidade; }
      .field-preco { grid-area: preco; }
      .field-btn { grid-area: btn; }

      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 600px) {
      .summary-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Controle de Compras</h1>
        <span>Meses ‚ûù Listas ‚ûù Itens, com carteiras, gr√°ficos por m√™s e por forma de pagamento.</span>
      </div>
      <button class="btn-outline" id="btnLimparLista" title="Limpar apenas a lista atual">
        üßπ Limpar lista atual
      </button>
    </header>

    <!-- MES / LISTAS -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="section-title">
        <span class="icon">üìÜ</span> Meses e listas de compras
      </div>

      <div class="row-flex">
        <label for="selectMes">M√™s de refer√™ncia:</label>
        <select id="selectMes"></select>
        <button class="btn-outline" id="btnNovoMes">‚ûï Novo m√™s</button>
      </div>

      <div class="row-flex">
        <label for="selectLista">Lista dentro do m√™s:</label>
        <select id="selectLista"></select>
        <button class="btn-outline" id="btnNovaListaMes">‚ûï Nova lista neste m√™s</button>
      </div>

      <small style="font-size:0.75rem;color:#6b7280;">
        Exemplo: M√™s 11/2025 ‚Üí listas "Compra grande", "Reposi√ß√£o", "Churrasco".
      </small>
    </div>

    <!-- CARTEIRAS -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="section-title">
        <span class="icon">üëõ</span> Carteiras / formas de pagamento
      </div>

      <div class="row-flex">
        <label for="novaCarteiraNome">Nova carteira:</label>
        <input type="text" id="novaCarteiraNome" placeholder="Ex: Pix, Cr√©dito Nubank, D√©bito Caixa, VR, Dinheiro">
        <button class="btn-outline" id="btnAdicionarCarteira">‚ûï Adicionar carteira</button>
      </div>

      <small style="font-size:0.75rem;color:#6b7280;">
        As carteiras ficam dispon√≠veis para sele√ß√£o em cada item da lista.
      </small>

      <div id="listaCarteirasResumo" class="chips"></div>
    </div>

    <!-- CONFIG / OR√áAMENTO DA LISTA ATUAL -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="section-title">
        <span class="icon">üí∞</span> Or√ßamento da lista atual
      </div>
      <div class="orcamento-box">
        <label>
          <input type="checkbox" id="usarOrcamento">
          Ativar controle de or√ßamento
        </label>
        <input
          type="number"
          id="valorOrcamento"
          placeholder="Valor dispon√≠vel (ex: 300,00)"
          step="0.01"
          min="0"
          disabled
        >
      </div>
      <small style="font-size:0.75rem;color:#6b7280;">
        Cada lista (dentro do m√™s) pode ter seu pr√≥prio or√ßamento, salvo localmente.
      </small>
    </div>

    <!-- FORM / ITENS DA LISTA ATUAL -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="section-title">
        <span class="icon">üõí</span> Itens da lista atual
      </div>

      <div class="form-grid">
        <div class="field field-produto">
          <label for="produto">Produto</label>
          <input type="text" id="produto" list="listaProdutos" placeholder="Ex: Arroz, Carne, Sab√£o em p√≥">
          <datalist id="listaProdutos"></datalist>
        </div>

        <div class="field field-categoria">
          <label for="categoria">Categoria</label>
          <input list="listaCategorias" id="categoria" placeholder="Ex: Hortifruti, Carne, Limpeza">
          <datalist id="listaCategorias">
            <option value="Hortifruti"></option>
            <option value="Carnes"></option>
            <option value="Padaria"></option>
            <option value="Bebidas"></option>
            <option value="Limpeza"></option>
            <option value="Higiene"></option>
            <option value="Mercearia"></option>
            <option value="Frios"></option>
          </datalist>
        </div>

        <div class="field field-carteira">
          <label for="carteiraItem">Carteira</label>
          <select id="carteiraItem"></select>
        </div>

        <div class="field field-qtde">
          <label for="quantidade">Quantidade</label>
          <input type="number" id="quantidade" step="0.01" min="0">
        </div>

        <div class="field field-unidade">
          <label for="unidade">Unidade</label>
          <select id="unidade">
            <option value="un">Unidade</option>
            <option value="kg">Kg</option>
            <option value="g">Gramas</option>
            <option value="L">Litros</option>
            <option value="cx">Caixa</option>
          </select>
        </div>

        <div class="field field-preco">
          <label for="preco">Pre√ßo por un/kg/L (R$)</label>
          <input type="number" id="preco" step="0.01" min="0">
        </div>

        <div class="field field-btn">
          <label>&nbsp;</label>
          <button class="btn-primary" id="btnAdicionar">
            ‚ûï Adicionar item
          </button>
        </div>
      </div>

      <!-- TABELA -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Produto</th>
              <th>Categoria</th>
              <th>Carteira</th>
              <th>Qtd</th>
              <th class="right">Pre√ßo un/kg/L</th>
              <th class="right">Total item</th>
              <th class="right"></th>
            </tr>
          </thead>
          <tbody id="tabelaItensBody"></tbody>
        </table>
      </div>

      <div class="table-actions">
        <span id="infoQuantidadeItens">Nenhum item adicionado ainda.</span>
        <span style="font-size:0.75rem;">Dica: use carteiras diferentes para ver o impacto de Pix, cr√©dito, VR, etc.</span>
      </div>
    </div>

    <!-- RESUMO DA LISTA ATUAL -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="section-title">
        <span class="icon">üìä</span> Resumo da lista atual
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Total da lista</div>
          <div class="summary-value" id="totalCompra">R$ 0,00</div>
          <div class="summary-extra" id="summaryItens">0 itens</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Ticket m√©dio por item</div>
          <div class="summary-value" id="ticketMedio">R$ 0,00</div>
          <div class="summary-extra">Total √∑ n¬∫ de itens</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Maior gasto em um item</div>
          <div class="summary-value" id="maiorItem">R$ 0,00</div>
          <div class="summary-extra" id="maiorItemNome">‚Äì</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Categorias distintas</div>
          <div class="summary-value" id="qtdCategorias">0</div>
          <div class="summary-extra">√ötil para an√°lise de perfil de consumo</div>
        </div>
      </div>

      <!-- OR√áAMENTO DETALHADO -->
      <div class="budget-bar-container" id="budgetContainer" style="display:none;">
        <div class="summary-label" style="margin-top:10px;">Utiliza√ß√£o do or√ßamento da lista</div>
        <div class="budget-bar-track">
          <div class="budget-bar-fill" id="budgetBar"></div>
        </div>
        <div class="budget-status" id="budgetStatus"></div>
      </div>
    </div>

    <!-- GR√ÅFICOS DA LISTA ATUAL -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="section-title">
        <span class="icon">üìà</span> Gr√°ficos da lista atual
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <h3>Gastos por categoria (lista)</h3>
          <div class="chart-helper">
            Participa√ß√£o de cada categoria dentro da lista escolhida.
          </div>
          <canvas id="chartCategorias" height="220"></canvas>
        </div>
        <div class="chart-card">
          <h3>Top produtos da lista</h3>
          <div class="chart-helper">
            At√© 5 produtos que mais pesam no valor da lista.
          </div>
          <canvas id="chartTopProdutos" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- VIS√ÉO GERAL POR M√äS / TOTAL -->
    <div class="card" style="margin-bottom:14px;">
      <div class="section-title">
        <span class="icon">üåé</span> Vis√£o geral por m√™s (todas as listas)
      </div>

      <div class="summary-grid" style="margin-bottom:10px;">
        <div class="summary-card">
          <div class="summary-label">Total geral (todos os meses)</div>
          <div class="summary-value" id="totalGeralMeses">R$ 0,00</div>
          <div class="summary-extra">Soma de todas as listas de todos os meses</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Quantidade de meses com dados</div>
          <div class="summary-value" id="qtdMeses">0</div>
          <div class="summary-extra">Meses com pelo menos uma lista</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">M√™s com maior gasto</div>
          <div class="summary-value" id="mesTopLabel">‚Äì</div>
          <div class="summary-extra" id="mesTopValor">R$ 0,00</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Listas totais</div>
          <div class="summary-value" id="qtdListasTotais">0</div>
          <div class="summary-extra">Somando todos os meses</div>
        </div>
      </div>

      <div class="chart-card">
        <h3>Totais por m√™s</h3>
        <div class="chart-helper">
          Soma de todas as listas dentro de cada m√™s.
        </div>
        <canvas id="chartTotaisMeses" height="240"></canvas>
      </div>
    </div>

    <!-- VIS√ÉO POR CARTEIRA -->
    <div class="card" style="margin-bottom:14px;">
      <div class="section-title">
        <span class="icon">üí≥</span> Vis√£o por carteira (todas as listas, todos os meses)
      </div>
      <div class="chart-card">
        <h3>Totais por carteira</h3>
        <div class="chart-helper">
          Quanto cada carteira (Pix, cr√©dito, d√©bito, VR etc.) est√° sendo usada no per√≠odo completo.
        </div>
        <canvas id="chartCarteiras" height="240"></canvas>
      </div>
    </div>

    <!-- BACKUP -->
    <div class="card">
      <div class="section-title">
        <span class="icon">üíæ</span> Backup de dados
      </div>
      <p style="font-size:0.8rem;color:#9ca3af;margin-top:0;margin-bottom:8px;">
        Exporte um arquivo de backup (.json) para usar seus dados em outra m√°quina ou navegador.
      </p>
      <div class="row-flex">
        <button class="btn-outline" id="btnExportarBackup">‚¨áÔ∏è Exportar backup</button>
        <button class="btn-outline" id="btnImportarBackup">‚¨ÜÔ∏è Importar backup</button>
        <input type="file" id="inputImportarBackup" accept=".json,application/json" style="display:none;">
      </div>
      <small style="font-size:0.75rem;color:#6b7280;">
        Depois de importar, os dados s√£o recarregados com o conte√∫do do backup (meses, listas, carteiras).
      </small>
    </div>
  </div>

  <!-- MODAL DE EDI√á√ÉO -->
  <div id="modalEdicao" class="modal-backdrop">
    <div class="modal-dialog">
      <h3 class="modal-title">Editar item</h3>

      <label class="edit-label">Produto</label>
      <input id="editProduto" class="edit-input">

      <label class="edit-label">Categoria</label>
      <input id="editCategoria" class="edit-input">

      <label class="edit-label">Carteira</label>
      <select id="editCarteira" class="edit-input"></select>

      <label class="edit-label">Quantidade</label>
      <input id="editQuantidade" type="number" step="0.01" min="0" class="edit-input">

      <label class="edit-label">Unidade</label>
      <select id="editUnidade" class="edit-input">
        <option value="un">Unidade</option>
        <option value="kg">Kg</option>
        <option value="g">Gramas</option>
        <option value="L">Litros</option>
        <option value="cx">Caixa</option>
      </select>

      <label class="edit-label">Pre√ßo un/kg/L (R$)</label>
      <input id="editPreco" type="number" step="0.01" min="0" class="edit-input">

      <div class="modal-actions">
        <button id="btnCancelarEdicao" class="btn-outline">Cancelar</button>
        <button id="btnSalvarEdicao" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // ----- LISTA PADR√ÉO DE PRODUTOS (autocomplete) -----
    const produtosSugeridos = [
      { nome: 'Arroz', categoria: 'Mercearia' },
      { nome: 'Feij√£o', categoria: 'Mercearia' },
      { nome: 'Macarr√£o', categoria: 'Mercearia' },
      { nome: 'A√ß√∫car', categoria: 'Mercearia' },
      { nome: 'Sal', categoria: 'Mercearia' },
      { nome: '√ìleo de soja', categoria: 'Mercearia' },
      { nome: 'Caf√©', categoria: 'Mercearia' },
      { nome: 'Farinha de trigo', categoria: 'Mercearia' },
      { nome: 'Molho de tomate', categoria: 'Mercearia' },

      { nome: 'Leite', categoria: 'Bebidas' },
      { nome: 'Refrigerante', categoria: 'Bebidas' },
      { nome: '√Ågua mineral', categoria: 'Bebidas' },
      { nome: 'Suco de caixinha', categoria: 'Bebidas' },

      { nome: 'P√£o franc√™s', categoria: 'Padaria' },
      { nome: 'P√£o de forma', categoria: 'Padaria' },
      { nome: 'Bolo', categoria: 'Padaria' },

      { nome: 'Queijo mussarela', categoria: 'Frios' },
      { nome: 'Presunto', categoria: 'Frios' },
      { nome: 'Mortadela', categoria: 'Frios' },

      { nome: 'Frango inteiro', categoria: 'Carnes' },
      { nome: 'Coxa de frango', categoria: 'Carnes' },
      { nome: 'Peito de frango', categoria: 'Carnes' },
      { nome: 'Carne bovina (patinho)', categoria: 'Carnes' },
      { nome: 'Carne bovina (m√∫sculo)', categoria: 'Carnes' },
      { nome: 'Lingui√ßa', categoria: 'Carnes' },

      { nome: 'Tomate', categoria: 'Hortifruti' },
      { nome: 'Cebola', categoria: 'Hortifruti' },
      { nome: 'Alho', categoria: 'Hortifruti' },
      { nome: 'Batata', categoria: 'Hortifruti' },
      { nome: 'Cenoura', categoria: 'Hortifruti' },
      { nome: 'Banana', categoria: 'Hortifruti' },
      { nome: 'Ma√ß√£', categoria: 'Hortifruti' },
      { nome: 'Laranja', categoria: 'Hortifruti' },

      { nome: 'Sab√£o em p√≥', categoria: 'Limpeza' },
      { nome: 'Detergente', categoria: 'Limpeza' },
      { nome: 'Desinfetante', categoria: 'Limpeza' },
      { nome: 'Amaciante', categoria: 'Limpeza' },
      { nome: '√Ågua sanit√°ria', categoria: 'Limpeza' },

      { nome: 'Sabonete', categoria: 'Higiene' },
      { nome: 'Shampoo', categoria: 'Higiene' },
      { nome: 'Condicionador', categoria: 'Higiene' },
      { nome: 'Papel higi√™nico', categoria: 'Higiene' },
      { nome: 'Creme dental', categoria: 'Higiene' },
      { nome: 'Desodorante', categoria: 'Higiene' }
    ];

    // ----- ESTADO: MESES, LISTAS, CARTEIRAS -----
    const STORAGE_KEY = 'controleComprasMeses_v1';
    let meses = [];
    let mesAtivoId = null;
    let listaAtivaId = null;
    let itemEditando = null;

    let carteiras = []; // {id, nome}

    // ----- ELEMENTOS -----
    const selectMes = document.getElementById('selectMes');
    const selectLista = document.getElementById('selectLista');
    const btnNovoMes = document.getElementById('btnNovoMes');
    const btnNovaListaMes = document.getElementById('btnNovaListaMes');
    const btnLimparLista = document.getElementById('btnLimparLista');

    const usarOrcamento = document.getElementById('usarOrcamento');
    const valorOrcamentoInput = document.getElementById('valorOrcamento');

    const btnAdicionar = document.getElementById('btnAdicionar');
    const tabelaItensBody = document.getElementById('tabelaItensBody');

    const totalCompraSpan = document.getElementById('totalCompra');
    const summaryItensSpan = document.getElementById('summaryItens');
    const ticketMedioSpan = document.getElementById('ticketMedio');
    const maiorItemSpan = document.getElementById('maiorItem');
    const maiorItemNomeSpan = document.getElementById('maiorItemNome');
    const qtdCategoriasSpan = document.getElementById('qtdCategorias');
    const infoQuantidadeItensSpan = document.getElementById('infoQuantidadeItens');

    const budgetContainer = document.getElementById('budgetContainer');
    const budgetBar = document.getElementById('budgetBar');
    const budgetStatus = document.getElementById('budgetStatus');

    const totalGeralMesesSpan = document.getElementById('totalGeralMeses');
    const qtdMesesSpan = document.getElementById('qtdMeses');
    const mesTopLabelSpan = document.getElementById('mesTopLabel');
    const mesTopValorSpan = document.getElementById('mesTopValor');
    const qtdListasTotaisSpan = document.getElementById('qtdListasTotais');

    const modalEdicao = document.getElementById('modalEdicao');
    const editProduto = document.getElementById('editProduto');
    const editCategoria = document.getElementById('editCategoria');
    const editCarteira = document.getElementById('editCarteira');
    const editQuantidade = document.getElementById('editQuantidade');
    const editUnidade = document.getElementById('editUnidade');
    const editPreco = document.getElementById('editPreco');
    const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
    const btnSalvarEdicao = document.getElementById('btnSalvarEdicao');

    const inputProduto = document.getElementById('produto');
    const inputCategoria = document.getElementById('categoria');
    const datalistProdutos = document.getElementById('listaProdutos');
    const selectCarteiraItem = document.getElementById('carteiraItem');

    const inputNovaCarteiraNome = document.getElementById('novaCarteiraNome');
    const btnAdicionarCarteira = document.getElementById('btnAdicionarCarteira');
    const listaCarteirasResumo = document.getElementById('listaCarteirasResumo');

    const btnExportarBackup = document.getElementById('btnExportarBackup');
    const btnImportarBackup = document.getElementById('btnImportarBackup');
    const inputImportarBackup = document.getElementById('inputImportarBackup');

    // Gr√°ficos
    let chartCategorias = null;
    let chartTopProdutos = null;
    let chartTotaisMeses = null;
    let chartCarteiras = null;

    // ----- FUN√á√ïES AUXILIARES -----
    function getMesAtivo() {
      return meses.find(m => m.id === mesAtivoId) || null;
    }

    function getListaAtiva() {
      const mes = getMesAtivo();
      if (!mes) return null;
      return mes.listas.find(l => l.id === listaAtivaId) || null;
    }

    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    function formatarQuantidade(quantidade, unidade) {
      if (unidade === 'g') {
        return quantidade.toFixed(0) + ' g';
      } else if (unidade === 'kg') {
        return quantidade.toFixed(3).replace('.', ',') + ' kg';
      } else if (unidade === 'L') {
        return quantidade.toFixed(3).replace('.', ',') + ' L';
      } else if (unidade === 'cx') {
        return quantidade.toFixed(2).replace('.', ',') + ' cx';
      } else {
        return quantidade.toFixed(2).replace('.', ',') + ' un';
      }
    }

    function idMesAtual() {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = String(hoje.getMonth() + 1).padStart(2, '0');
      return `${ano}-${mes}`;
    }

    function labelMes(idMes) {
      const [ano, mes] = idMes.split('-');
      return `${mes}/${ano}`;
    }

    function salvarEstado() {
      const data = {
        meses,
        mesAtivoId,
        listaAtivaId,
        carteiras
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function inicializarCarteirasPadrao() {
      return [
        { id: 'c1', nome: 'Dinheiro' },
        { id: 'c2', nome: 'Pix' },
        { id: 'c3', nome: 'Cr√©dito' },
        { id: 'c4', nome: 'D√©bito' },
        { id: 'c5', nome: 'VR' },
        { id: 'c6', nome: 'VA' }
      ];
    }

    function carregarEstado() {
      const raw = localStorage.getItem(STORAGE_KEY);

      if (!raw) {
        const id = idMesAtual();
        const mesPadrao = {
          id,
          nome: labelMes(id),
          listas: [{
            id: 'lista-1',
            nome: 'Lista padr√£o',
            itens: [],
            proximoId: 1,
            usarOrcamento: false,
            valorOrcamento: ''
          }]
        };
        meses = [mesPadrao];
        mesAtivoId = id;
        listaAtivaId = mesPadrao.listas[0].id;
        carteiras = inicializarCarteirasPadrao();
        salvarEstado();
        return;
      }

      try {
        const data = JSON.parse(raw);
        if (Array.isArray(data.meses) && data.meses.length > 0) {
          meses = data.meses;
          mesAtivoId = data.mesAtivoId || meses[0].id;
          const mes = getMesAtivo();
          if (mes) {
            listaAtivaId = data.listaAtivaId || (mes.listas[0] && mes.listas[0].id);
          } else {
            listaAtivaId = null;
          }
        } else {
          const id = idMesAtual();
          const mesPadrao = {
            id,
            nome: labelMes(id),
            listas: [{
              id: 'lista-1',
              nome: 'Lista padr√£o',
              itens: [],
              proximoId: 1,
              usarOrcamento: false,
              valorOrcamento: ''
            }]
          };
          meses = [mesPadrao];
          mesAtivoId = id;
          listaAtivaId = mesPadrao.listas[0].id;
        }

        if (Array.isArray(data.carteiras) && data.carteiras.length > 0) {
          carteiras = data.carteiras;
        } else {
          carteiras = inicializarCarteirasPadrao();
        }
      } catch (e) {
        console.error('Erro ao carregar estado:', e);
        const id = idMesAtual();
        const mesPadrao = {
          id,
          nome: labelMes(id),
          listas: [{
            id: 'lista-1',
            nome: 'Lista padr√£o',
            itens: [],
            proximoId: 1,
            usarOrcamento: false,
            valorOrcamento: ''
          }]
        };
        meses = [mesPadrao];
        mesAtivoId = id;
        listaAtivaId = mesPadrao.listas[0].id;
        carteiras = inicializarCarteirasPadrao();
        salvarEstado();
      }
    }

    // ----- AUTOCOMPLETE PRODUTO -> CATEGORIA -----
    function inicializarListaProdutos() {
      datalistProdutos.innerHTML = '';
      produtosSugeridos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nome;
        datalistProdutos.appendChild(opt);
      });
    }

    function sugerirCategoriaParaProduto(nomeProduto) {
      if (!nomeProduto) return;
      const nome = nomeProduto.trim().toLowerCase();
      if (!nome) return;
      const encontrado = produtosSugeridos.find(p => p.nome.toLowerCase() === nome);
      if (encontrado && !inputCategoria.value.trim()) {
        inputCategoria.value = encontrado.categoria;
      }
    }

    inputProduto.addEventListener('change', () => {
      sugerirCategoriaParaProduto(inputProduto.value);
    });
    inputProduto.addEventListener('blur', () => {
      sugerirCategoriaParaProduto(inputProduto.value);
    });

    // ----- CARTEIRAS: UI -----
    function atualizarSelectCarteiras() {
      selectCarteiraItem.innerHTML = '';
      editCarteira.innerHTML = '';

      if (carteiras.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Sem carteiras';
        selectCarteiraItem.appendChild(opt);
        const opt2 = opt.cloneNode(true);
        editCarteira.appendChild(opt2);
        return;
      }

      carteiras.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nome;
        selectCarteiraItem.appendChild(opt);

        const opt2 = document.createElement('option');
        opt2.value = c.id;
        opt2.textContent = c.nome;
        editCarteira.appendChild(opt2);
      });
    }

    function atualizarResumoCarteirasChips() {
      listaCarteirasResumo.innerHTML = '';
      if (carteiras.length === 0) {
        const span = document.createElement('span');
        span.textContent = 'Nenhuma carteira cadastrada.';
        span.style.fontSize = '0.8rem';
        span.style.color = '#6b7280';
        listaCarteirasResumo.appendChild(span);
        return;
      }

      carteiras.forEach(c => {
        const chip = document.createElement('div');
        chip.classList.add('chip');
        chip.textContent = c.nome;
        listaCarteirasResumo.appendChild(chip);
      });
    }

    function adicionarCarteira() {
      const nome = inputNovaCarteiraNome.value.trim();
      if (!nome) {
        alert('Informe o nome da carteira (ex: Pix, Cr√©dito Nubank, VR).');
        return;
      }
      const id = 'c' + Date.now();
      carteiras.push({ id, nome });
      inputNovaCarteiraNome.value = '';
      atualizarSelectCarteiras();
      atualizarResumoCarteirasChips();
      salvarEstado();
    }

    btnAdicionarCarteira.addEventListener('click', (e) => {
      e.preventDefault();
      adicionarCarteira();
    });

    inputNovaCarteiraNome.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adicionarCarteira();
      }
    });

    function nomeCarteiraPorId(id) {
      const c = carteiras.find(x => x.id === id);
      return c ? c.nome : 'Sem carteira';
    }

    // ----- UI: MESES E LISTAS -----
    function atualizarSelectMeses() {
      selectMes.innerHTML = '';
      meses.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.nome || labelMes(m.id);
        if (m.id === mesAtivoId) opt.selected = true;
        selectMes.appendChild(opt);
      });
    }

    function atualizarSelectListas() {
      const mes = getMesAtivo();
      selectLista.innerHTML = '';
      if (!mes || !Array.isArray(mes.listas) || mes.listas.length === 0) {
        listaAtivaId = null;
        return;
      }
      mes.listas.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.nome;
        if (l.id === listaAtivaId) opt.selected = true;
        selectLista.appendChild(opt);
      });
      if (!listaAtivaId) {
        listaAtivaId = mes.listas[0].id;
      }
    }

    function carregarListaNaUI() {
      const lista = getListaAtiva();
      if (!lista) {
        tabelaItensBody.innerHTML = '';
        infoQuantidadeItensSpan.textContent = 'Nenhuma lista selecionada.';
        totalCompraSpan.textContent = 'R$ 0,00';
        summaryItensSpan.textContent = '0 itens';
        ticketMedioSpan.textContent = 'R$ 0,00';
        maiorItemSpan.textContent = 'R$ 0,00';
        maiorItemNomeSpan.textContent = '‚Äì';
        qtdCategoriasSpan.textContent = '0';
        budgetContainer.style.display = 'none';
        atualizarGraficos();
        atualizarGraficosGerais();
        return;
      }

      usarOrcamento.checked = !!lista.usarOrcamento;
      valorOrcamentoInput.disabled = !lista.usarOrcamento;
      valorOrcamentoInput.value = lista.valorOrcamento || '';

      renderizarTabela();
      atualizarResumo();
    }

    // ----- RENDERIZA√á√ÉO LISTA -----
    function renderizarTabela() {
      const lista = getListaAtiva();
      if (!lista) return;
      const itens = lista.itens || [];

      tabelaItensBody.innerHTML = '';

      itens.forEach((item, index) => {
        const tr = document.createElement('tr');

        const tdSeq = document.createElement('td');
        tdSeq.textContent = index + 1;

        const tdProduto = document.createElement('td');
        tdProduto.textContent = item.produto;

        const tdCategoria = document.createElement('td');
        const categoriaLabel = item.categoria && item.categoria.trim()
          ? item.categoria.trim()
          : 'Sem categoria';
        const spanTag = document.createElement('span');
        spanTag.classList.add('tag');
        if (!item.categoria) spanTag.classList.add('tag-default');
        spanTag.textContent = categoriaLabel;
        tdCategoria.appendChild(spanTag);

        const tdCarteira = document.createElement('td');
        const carteiraNome = item.carteiraId ? nomeCarteiraPorId(item.carteiraId) : 'Sem carteira';
        const spanCarteira = document.createElement('span');
        spanCarteira.classList.add('tag');
        spanCarteira.textContent = carteiraNome;
        tdCarteira.appendChild(spanCarteira);

        const tdQuantidade = document.createElement('td');
        tdQuantidade.textContent = formatarQuantidade(item.quantidade, item.unidade);

        const tdPreco = document.createElement('td');
        tdPreco.classList.add('right');
        tdPreco.textContent = formatarMoeda(item.preco);

        const tdTotalItem = document.createElement('td');
        tdTotalItem.classList.add('right');
        tdTotalItem.textContent = formatarMoeda(item.totalItem);

        const tdAcao = document.createElement('td');
        tdAcao.classList.add('right');

        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.classList.add('btn-small', 'btn-outline');
        btnEditar.style.marginRight = '6px';
        btnEditar.addEventListener('click', () => abrirEditor(item.id));
        tdAcao.appendChild(btnEditar);

        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Excluir';
        btnRemover.classList.add('btn-small', 'btn-danger');
        btnRemover.addEventListener('click', () => removerItem(item.id));
        tdAcao.appendChild(btnRemover);

        tr.appendChild(tdSeq);
        tr.appendChild(tdProduto);
        tr.appendChild(tdCategoria);
        tr.appendChild(tdCarteira);
        tr.appendChild(tdQuantidade);
        tr.appendChild(tdPreco);
        tr.appendChild(tdTotalItem);
        tr.appendChild(tdAcao);

        tabelaItensBody.appendChild(tr);
      });

      if (itens.length === 0) {
        infoQuantidadeItensSpan.textContent = 'Nenhum item adicionado ainda.';
      } else if (itens.length === 1) {
        infoQuantidadeItensSpan.textContent = '1 item na lista.';
      } else {
        infoQuantidadeItensSpan.textContent = `${itens.length} itens na lista.`;
      }
    }

    function atualizarResumo() {
      const lista = getListaAtiva();
      if (!lista) return;

      const itens = lista.itens || [];
      const total = itens.reduce((soma, item) => soma + item.totalItem, 0);

      totalCompraSpan.textContent = formatarMoeda(total);
      summaryItensSpan.textContent = `${itens.length} item${itens.length === 1 ? '' : 's'}`;

      const ticketMedio = itens.length > 0 ? total / itens.length : 0;
      ticketMedioSpan.textContent = formatarMoeda(ticketMedio);

      if (itens.length > 0) {
        const maior = itens.reduce((acc, item) =>
          item.totalItem > acc.totalItem ? item : acc, itens[0]);
        maiorItemSpan.textContent = formatarMoeda(maior.totalItem);
        maiorItemNomeSpan.textContent = maior.produto;
      } else {
        maiorItemSpan.textContent = 'R$ 0,00';
        maiorItemNomeSpan.textContent = '‚Äì';
      }

      const categoriasSet = new Set(
        itens.map(i => (i.categoria && i.categoria.trim()) ? i.categoria.trim() : 'Sem categoria')
      );
      qtdCategoriasSpan.textContent = itens.length === 0 ? 0 : categoriasSet.size;

      // Or√ßamento da lista
      if (lista.usarOrcamento && lista.valorOrcamento !== '') {
        const orcamento = parseFloat(String(lista.valorOrcamento).replace(',', '.')) || 0;
        if (orcamento > 0) {
          budgetContainer.style.display = 'block';
          const perc = Math.min(100, (total / orcamento) * 100);
          budgetBar.style.width = perc.toFixed(1) + '%';

          const diferenca = orcamento - total;
          if (diferenca > 0) {
            budgetStatus.textContent =
              `Voc√™ ainda pode gastar ${formatarMoeda(diferenca)} (${perc.toFixed(1)}% do or√ßamento utilizado).`;
            budgetStatus.className = 'budget-status budget-ok';
          } else if (diferenca === 0) {
            budgetStatus.textContent =
              `Voc√™ atingiu exatamente o or√ßamento (${perc.toFixed(1)}% utilizado).`;
            budgetStatus.className = 'budget-status budget-alerta';
          } else {
            budgetStatus.textContent =
              `Voc√™ ultrapassou o or√ßamento em ${formatarMoeda(Math.abs(diferenca))} (${perc.toFixed(1)}% do or√ßamento).`;
            budgetStatus.className = 'budget-status budget-estourado';
          }
        } else {
          budgetContainer.style.display = 'none';
        }
      } else {
        budgetContainer.style.display = 'none';
      }

      atualizarGraficos();
      atualizarGraficosGerais();
      salvarEstado();
    }

    // ----- GR√ÅFICOS DA LISTA ATUAL -----
    function atualizarGraficos() {
      const lista = getListaAtiva();
      const itens = lista ? (lista.itens || []) : [];

      // Gastos por categoria
      const gastosPorCategoria = {};
      itens.forEach(item => {
        const cat = (item.categoria && item.categoria.trim()) ? item.categoria.trim() : 'Sem categoria';
        gastosPorCategoria[cat] = (gastosPorCategoria[cat] || 0) + item.totalItem;
      });

      const categorias = Object.keys(gastosPorCategoria);
      const valoresCategorias = Object.values(gastosPorCategoria);

      const ctxCat = document.getElementById('chartCategorias').getContext('2d');
      if (chartCategorias) chartCategorias.destroy();
      chartCategorias = new Chart(ctxCat, {
        type: 'doughnut',
        data: {
          labels: categorias,
          datasets: [{ data: valoresCategorias }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#e5e7eb', font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  return `${label}: ${formatarMoeda(value)}`;
                }
              }
            }
          }
        }
      });

      // Top produtos
      const itensOrdenados = [...itens]
        .sort((a, b) => b.totalItem - a.totalItem)
        .slice(0, 5);
      const labelsTop = itensOrdenados.map(i => i.produto);
      const valoresTop = itensOrdenados.map(i => i.totalItem);

      const ctxTop = document.getElementById('chartTopProdutos').getContext('2d');
      if (chartTopProdutos) chartTopProdutos.destroy();
      chartTopProdutos = new Chart(ctxTop, {
        type: 'bar',
        data: {
          labels: labelsTop,
          datasets: [{ data: valoresTop }]
        },
        options: {
          scales: {
            x: { ticks: { color: '#e5e7eb', font: { size: 11 } } },
            y: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 },
                callback: (value) => formatarMoeda(value)
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => formatarMoeda(context.raw || 0)
              }
            }
          }
        }
      });
    }

    // ----- GR√ÅFICO GERAL POR M√äS E POR CARTEIRA -----
    function atualizarGraficosGerais() {
      const labelsMes = [];
      const valoresMes = [];
      let totalGeral = 0;
      let qtdListasTotais = 0;

      const totaisCarteiras = {}; // idCarteira -> valor

      meses.forEach(m => {
        let totalMes = 0;
        (m.listas || []).forEach(l => {
          qtdListasTotais++;
          (l.itens || []).forEach(item => {
            totalMes += item.totalItem;

            const idCarteira = item.carteiraId || 'sem';
            totaisCarteiras[idCarteira] = (totaisCarteiras[idCarteira] || 0) + item.totalItem;
          });
        });
        labelsMes.push(m.nome || labelMes(m.id));
        valoresMes.push(totalMes);
        totalGeral += totalMes;
      });

      totalGeralMesesSpan.textContent = formatarMoeda(totalGeral);
      qtdMesesSpan.textContent = meses.length;
      qtdListasTotaisSpan.textContent = qtdListasTotais;

      if (meses.length > 0) {
        let idxTop = 0;
        let maxVal = valoresMes[0] || 0;
        for (let i = 1; i < valoresMes.length; i++) {
          if (valoresMes[i] > maxVal) {
            maxVal = valoresMes[i];
            idxTop = i;
          }
        }
        mesTopLabelSpan.textContent = labelsMes[idxTop];
        mesTopValorSpan.textContent = formatarMoeda(maxVal);
      } else {
        mesTopLabelSpan.textContent = '‚Äì';
        mesTopValorSpan.textContent = 'R$ 0,00';
      }

      // Gr√°fico por m√™s
      const ctxMes = document.getElementById('chartTotaisMeses').getContext('2d');
      if (chartTotaisMeses) chartTotaisMeses.destroy();
      chartTotaisMeses = new Chart(ctxMes, {
        type: 'bar',
        data: {
          labels: labelsMes,
          datasets: [{ data: valoresMes }]
        },
        options: {
          scales: {
            x: { ticks: { color: '#e5e7eb', font: { size: 11 } } },
            y: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 },
                callback: (value) => formatarMoeda(value)
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => formatarMoeda(context.raw || 0)
              }
            }
          }
        }
      });

      // Gr√°fico por carteira
      const labelsCarteiras = [];
      const valoresCarteiras = [];

      Object.keys(totaisCarteiras).forEach(id => {
        if (id === 'sem') {
          labelsCarteiras.push('Sem carteira');
        } else {
          labelsCarteiras.push(nomeCarteiraPorId(id));
        }
        valoresCarteiras.push(totaisCarteiras[id]);
      });

      const ctxCarteiras = document.getElementById('chartCarteiras').getContext('2d');
      if (chartCarteiras) chartCarteiras.destroy();
      chartCarteiras = new Chart(ctxCarteiras, {
        type: 'bar',
        data: {
          labels: labelsCarteiras,
          datasets: [{ data: valoresCarteiras }]
        },
        options: {
          scales: {
            x: { ticks: { color: '#e5e7eb', font: { size: 11 } } },
            y: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 },
                callback: (value) => formatarMoeda(value)
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => formatarMoeda(context.raw || 0)
              }
            }
          }
        }
      });
    }

    // ----- A√á√ïES (ITENS) -----
    function adicionarItem() {
      const lista = getListaAtiva();
      if (!lista) return;

      const produto = inputProduto.value.trim();
      const categoria = inputCategoria.value.trim();
      const carteiraId = selectCarteiraItem.value || null;
      const quantidadeInput = document.getElementById('quantidade').value;
      const precoInput = document.getElementById('preco').value;
      const unidade = document.getElementById('unidade').value;

      const quantidade = parseFloat(String(quantidadeInput).replace(',', '.'));
      const preco = parseFloat(String(precoInput).replace(',', '.'));

      if (!produto) {
        alert('Informe o nome do produto.');
        return;
      }
      if (isNaN(quantidade) || quantidade <= 0) {
        alert('Informe uma quantidade v√°lida.');
        return;
      }
      if (isNaN(preco) || preco <= 0) {
        alert('Informe um pre√ßo v√°lido.');
        return;
      }

      let totalItem;
      if (unidade === 'g') {
        totalItem = (quantidade / 1000) * preco;
      } else {
        totalItem = quantidade * preco;
      }

      const item = {
        id: lista.proximoId++,
        produto,
        categoria,
        quantidade,
        unidade,
        preco,
        totalItem,
        carteiraId
      };

      lista.itens.push(item);

      inputProduto.value = '';
      inputCategoria.value = '';
      document.getElementById('quantidade').value = '';
      document.getElementById('preco').value = '';
      inputProduto.focus();

      renderizarTabela();
      atualizarResumo();
    }

    function removerItem(id) {
      const lista = getListaAtiva();
      if (!lista) return;

      lista.itens = lista.itens.filter(i => i.id !== id);
      renderizarTabela();
      atualizarResumo();
    }

    function limparLista() {
      const lista = getListaAtiva();
      if (!lista) return;

      if (!confirm(`Limpar todos os itens e o or√ßamento da lista "${lista.nome}"?`)) return;

      lista.itens = [];
      lista.proximoId = 1;
      lista.usarOrcamento = false;
      lista.valorOrcamento = '';

      carregarListaNaUI();
      salvarEstado();
    }

    // ----- EDI√á√ÉO DE ITEM -----
    function abrirEditor(id) {
      const lista = getListaAtiva();
      if (!lista) return;

      const item = lista.itens.find(i => i.id === id);
      if (!item) return;

      itemEditando = item;

      editProduto.value = item.produto;
      editCategoria.value = item.categoria || '';
      editQuantidade.value = item.quantidade;
      editUnidade.value = item.unidade;
      editPreco.value = item.preco;

      // set carteira
      editarPreencherCarteirasSelect();
      editCarteira.value = item.carteiraId || '';
      modalEdicao.style.display = 'flex';
    }

    function editarPreencherCarteirasSelect() {
      editCarteira.innerHTML = '';
      const optNenhuma = document.createElement('option');
      optNenhuma.value = '';
      optNenhuma.textContent = 'Sem carteira';
      editCarteira.appendChild(optNenhuma);

      carteiras.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nome;
        editCarteira.appendChild(opt);
      });
    }

    function fecharEditor() {
      modalEdicao.style.display = 'none';
      itemEditando = null;
    }

    btnCancelarEdicao.addEventListener('click', fecharEditor);

    btnSalvarEdicao.addEventListener('click', () => {
      if (!itemEditando) return;

      const prod = editProduto.value.trim();
      const cat = editCategoria.value.trim();
      const qtd = parseFloat(String(editQuantidade.value).replace(',', '.'));
      const und = editUnidade.value;
      const preco = parseFloat(String(editPreco.value).replace(',', '.'));
      const carteiraId = editCarteira.value || null;

      if (!prod || isNaN(qtd) || qtd <= 0 || isNaN(preco) || preco <= 0) {
        alert('Preencha os campos corretamente.');
        return;
      }

      let totalItem = und === 'g'
        ? (qtd / 1000) * preco
        : qtd * preco;

      itemEditando.produto = prod;
      itemEditando.categoria = cat;
      itemEditando.quantidade = qtd;
      itemEditando.unidade = und;
      itemEditando.preco = preco;
      itemEditando.totalItem = totalItem;
      itemEditando.carteiraId = carteiraId;

      renderizarTabela();
      atualizarResumo();
      fecharEditor();
    });

    modalEdicao.addEventListener('click', (e) => {
      if (e.target === modalEdicao) fecharEditor();
    });

    // ----- EVENTOS: OR√áAMENTO, LISTAS, MESES -----
    usarOrcamento.addEventListener('change', () => {
      const lista = getListaAtiva();
      if (!lista) return;

      lista.usarOrcamento = usarOrcamento.checked;
      if (!lista.usarOrcamento) {
        lista.valorOrcamento = '';
        valorOrcamentoInput.value = '';
      }
      valorOrcamentoInput.disabled = !lista.usarOrcamento;
      atualizarResumo();
    });

    valorOrcamentoInput.addEventListener('input', () => {
      const lista = getListaAtiva();
      if (!lista) return;
      lista.valorOrcamento = valorOrcamentoInput.value;
      atualizarResumo();
    });

    btnAdicionar.addEventListener('click', (e) => {
      e.preventDefault();
      adicionarItem();
    });

    document.getElementById('preco').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adicionarItem();
      }
    });

    btnLimparLista.addEventListener('click', (e) => {
      e.preventDefault();
      limparLista();
    });

    btnNovoMes.addEventListener('click', () => {
      const hoje = new Date();
      const anoDefault = hoje.getFullYear();
      const mesDefault = String(hoje.getMonth() + 1).padStart(2, '0');
      const input = prompt('Informe o m√™s/ano no formato MM/AAAA:', `${mesDefault}/${anoDefault}`);
      if (!input) return;

      const match = input.match(/^(\d{2})\/(\d{4})$/);
      if (!match) {
        alert('Formato inv√°lido. Use MM/AAAA, por exemplo 11/2025.');
        return;
      }

      const mes = match[1];
      const ano = match[2];
      const id = `${ano}-${mes}`;
      if (meses.some(m => m.id === id)) {
        alert('Esse m√™s j√° existe. Selecione no combobox.');
        return;
      }

      const novoMes = {
        id,
        nome: `${mes}/${ano}`,
        listas: [{
          id: 'lista-1',
          nome: 'Lista padr√£o',
          itens: [],
          proximoId: 1,
          usarOrcamento: false,
          valorOrcamento: ''
        }]
      };
      meses.push(novoMes);
      mesAtivoId = id;
      listaAtivaId = novoMes.listas[0].id;
      atualizarSelectMeses();
      atualizarSelectListas();
      carregarListaNaUI();
      salvarEstado();
    });

    btnNovaListaMes.addEventListener('click', () => {
      const mes = getMesAtivo();
      if (!mes) return;
      const nome = prompt('Nome da nova lista para este m√™s:', 'Nova lista');
      if (!nome || !nome.trim()) return;

      const id = 'lista-' + Date.now();
      const novaLista = {
        id,
        nome: nome.trim(),
        itens: [],
        proximoId: 1,
        usarOrcamento: false,
        valorOrcamento: ''
      };
      mes.listas.push(novaLista);
      listaAtivaId = id;
      atualizarSelectListas();
      carregarListaNaUI();
      salvarEstado();
    });

    selectMes.addEventListener('change', () => {
      mesAtivoId = selectMes.value;
      const mes = getMesAtivo();
      if (mes && mes.listas.length > 0) {
        listaAtivaId = mes.listas[0].id;
      } else {
        listaAtivaId = null;
      }
      atualizarSelectListas();
      carregarListaNaUI();
      salvarEstado();
    });

    selectLista.addEventListener('change', () => {
      listaAtivaId = selectLista.value;
      carregarListaNaUI();
      salvarEstado();
    });

    // ----- BACKUP: EXPORTAR / IMPORTAR -----
    function exportarBackup() {
      salvarEstado();
      const raw = localStorage.getItem(STORAGE_KEY) ||
        JSON.stringify({ meses, mesAtivoId, listaAtivaId, carteiras });
      const blob = new Blob([raw], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const hoje = new Date().toISOString().slice(0, 10);
      const a = document.createElement('a');
      a.href = url;
      a.download = `compras-backup-${hoje}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importarBackup(arquivo) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data || !Array.isArray(data.meses)) {
            alert('Arquivo de backup inv√°lido.');
            return;
          }
          meses = data.meses;
          mesAtivoId = data.mesAtivoId || (meses[0] && meses[0].id);
          const mes = getMesAtivo();
          if (mes && mes.listas.length > 0) {
            listaAtivaId = data.listaAtivaId || mes.listas[0].id;
          } else {
            listaAtivaId = null;
          }

          if (Array.isArray(data.carteiras) && data.carteiras.length > 0) {
            carteiras = data.carteiras;
          } else {
            carteiras = inicializarCarteirasPadrao();
          }

          salvarEstado();
          atualizarSelectMeses();
          atualizarSelectListas();
          atualizarSelectCarteiras();
          atualizarResumoCarteirasChips();
          carregarListaNaUI();
          alert('Backup importado com sucesso!');
        } catch (err) {
          console.error(err);
          alert('Erro ao ler o arquivo de backup.');
        }
      };
      reader.readAsText(arquivo, 'utf-8');
    }

    btnExportarBackup.addEventListener('click', () => {
      exportarBackup();
    });

    btnImportarBackup.addEventListener('click', () => {
      inputImportarBackup.click();
    });

    inputImportarBackup.addEventListener('change', () => {
      const arquivo = inputImportarBackup.files[0];
      if (!arquivo) return;
      importarBackup(arquivo);
      inputImportarBackup.value = '';
    });

    // ----- INICIALIZA√á√ÉO -----
    inicializarListaProdutos();
    carregarEstado();
    atualizarSelectMeses();
    atualizarSelectListas();
    atualizarSelectCarteiras();
    atualizarResumoCarteirasChips();
    carregarListaNaUI();
  </script>
</body>
</html>
